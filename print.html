<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>DiffSL</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="language.html"><strong aria-hidden="true">2.</strong> DiffSL Language</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">DiffSL</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="diffsl"><a class="header" href="#diffsl">DiffSL</a></h1>
<img src="https://github.com/martinjrobins/diffsl/actions/workflows/ci.yml/badge.svg" alt="CI build status badge">
<p>A compiler for a domain-specific language for ordinary differential equations (ODEs) of the following form:</p>
<p>$$
M(t) \frac{d\mathbf{u}}{dt} = F(\mathbf{u}, t)
$$</p>
<p>As an example, the following code defines a classic DAE testcase, the Robertson
(1966) problem, which models the  kinetics of an autocatalytic reaction, given
by the following set of equations:</p>
<p>$$
\begin{align}
\frac{dx}{dt} &amp;= -0.04x + 10^4 y z \
\frac{dy}{dt} &amp;= 0.04x - 10^4 y z - 3 \cdot 10^7 y^2 \
0 &amp;= x + y + z - 1
\end{align}
$$</p>
<p>The DiffSL code for this problem is as follows:</p>
<pre><code>in = [k1, k2, k3]
k1 { 0.04 }
k2 { 10000 }
k3 { 30000000 }
u_i {
  x = 1,
  y = 0,
  z = 0,
}
dudt_i {
  dxdt = 1,
  dydt = 0,
  dzdt = 0,
}
M_i {
  dxdt,
  dydt,
  0,
}
F_i {
  -k1 * x + k2 * y * z,
  k1 * x - k2 * y * z - k3 * y * y,
  1 - x - y - z,
}
out_i {
  x,
  y,
  z,
}
</code></pre>
<h2 id="diffsl-language-features"><a class="header" href="#diffsl-language-features">DiffSL Language Features</a></h2>
<p>See the <a href="../../index.html#diffsl-language">DiffSL Language</a> section for a full description.</p>
<ul>
<li>Tensor types:
<ul>
<li>Scalars (double precision floating point numbers)</li>
<li>Vectors (1D arrays of scalars)</li>
<li>N-dimensional tensor of scalars</li>
<li>Sparse/dense/diagonal tensors</li>
</ul>
</li>
<li>Tensor operations:
<ul>
<li>Elementwise operations</li>
<li>Broadcasting</li>
<li>Tensor contractions/matmul/translation etc via index notation</li>
</ul>
</li>
</ul>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>You will need to install the <a href="https://llvm.org/">LLVM project</a>. The easiest way to
install this is to use the package manager for your operating system. For
example, on Ubuntu you can install these with the following command:</p>
<pre><code class="language-bash">sudo apt-get install llvm
</code></pre>
<h2 id="installing-diffsl"><a class="header" href="#installing-diffsl">Installing DiffSL</a></h2>
<p>You can install DiffSL using cargo. You will need to indicate the llvm version you have installed using a feature flag. For example, for llvm 14:</p>
<pre><code class="language-bash">cargo add diffsl --features llvm14-0
</code></pre>
<p>Other versions of llvm are also supported given by the features <code>llvm4-0</code>, <code>llvm5-0</code>, <code>llvm6-0</code>, <code>llvm7-0</code>, <code>llvm8-0</code>, <code>llvm9-0</code>, <code>llvm10-0</code>, <code>llvm11-0</code>, <code>llvm12-0</code>, <code>llvm13-0</code>, <code>llvm14-0</code>, <code>llvm15-0</code>, <code>llvm16-0</code>, <code>llvm17-0</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="diffsl-language"><a class="header" href="#diffsl-language">DiffSL Language</a></h1>
<p>The DSL is designed to be an easy and flexible language for specifying
DAE systems and is based on the idea that a DAE system can be specified by a set
of equations of the form:</p>
<p>$$
M(t) \frac{d\mathbf{u}}{dt} = F(\mathbf{u}, t)
$$</p>
<p>where $\mathbf{u}$ is the vector of state variables and $t$ is the time. The DSL
allows the user to specify the state vector $\mathbf{u}$ and the RHS function $F$.
Optionally, the user can also define the derivative of the state vector $d\mathbf{u}/dt$
and the mass matrix $M$ as a function of $d\mathbf{u}/dt$ (note that this function should be linear!).
The user is also free to define an an arbitrary number of intermediate
scalars and vectors of the users that are required to calculate $F$ and $M$.</p>
<h2 id="defining-variables"><a class="header" href="#defining-variables">Defining variables</a></h2>
<p>The DSL allows the user to define scalars, vectors, and dense/sparse/diagonal
n-dimensional tensors.  You can optionally label the elements of a vector or
tensor for later use.</p>
<p>For example, to define a scalar variable $k$ with value $1$, we write:</p>
<pre><code>k { 1.0 }
</code></pre>
<p>To define a vector variable $\mathbf{v}$ with 3 elements that are labelled, we write:</p>
<pre><code>v_i {
 x = 1.0,
 y = 2.0,
 z = 3.0,
}
</code></pre>
<p>The subscript <code>_i</code> indicates that this is a 1D vector, and $x$, $y$, and $z$ are
defined as labels to the 3 elements of the vector.  Later in the code, we could
refer to either the whole vector <code>v_i</code> for $\mathbf{v}$ or to the individual
elements $x$, $y$, and $z$, which are scalars.</p>
<p>To define dense 2x3 matrix $A$ with all elements set to <code>1.0</code>, we write:</p>
<pre><code>A_ij {
 (0:2, 0:3) = 1.0,
}
</code></pre>
<p>Note the two subscript to indicate that this is a 2D tensor. The size of the
tensor is given in the brackets, and the elements are set to $1$.  If we have
additional rows, we can add them as follows:</p>
<pre><code>A_ij {
 (0:2, 0:3) = 1.0,
 (3:4, 0:3) = 2.0,
}
</code></pre>
<p>We can define a sparse matrix $B$ by specifying the non-zero elements:</p>
<pre><code>B_ij {
 (0, 0) = 1.0,
 (0, 1) = 2.0,
 (1, 1) = 3.0,
}
</code></pre>
<p>We can also define a diagonal identity matrix $I$ by specifying the diagonal
elements using a different range syntax:</p>
<pre><code>I_ij {
 (0..2, 0..2) = 1.0,
}
</code></pre>
<h2 id="operations"><a class="header" href="#operations">Operations</a></h2>
<p>We can use standard algebraic operations on variables. To refer to previously
defined variables, we use the variable name, making sure to use the correct
subscript if it is a vector or tensor.</p>
<p>For example, to define a scalar variable $a$ as the sum of two other scalar
variables $b$ and $c$, we write:</p>
<pre><code>a { b + c }
</code></pre>
<p>To define a vector variable $\mathbf{V}$ as the sum of two other vector
variables $\mathbf{u}$ and $\mathbf{w}$, we write:</p>
<pre><code>v_i { u_i + w_i }
</code></pre>
<p>The indexing can be used to perform translations on tensors, for example the
following will define a new tensor $C$ that is the sum of $A$ and $B^T$:</p>
<pre><code>C_ij { A_ij + B_ji }
</code></pre>
<p>Tensor indexing notation can also matrix-vector multiplications and any other
contraction operations. Any indices that do not appear in the output will be
summed over.  For example, the following will define a new vector $v$ that is
the result of a matrix-vector multiplication:</p>
<pre><code>v_i { A_ij * u_j }
</code></pre>
<p>Broadcasting is also supported, for example the following will define a new
matrix $D$ that is the sum of $A$ and a vector $v$:</p>
<pre><code>D_ij { A_ij + v_j }
</code></pre>
<p>Here the vector $v$ is broadcast to the same shape as $A$ before the addition.</p>
<h2 id="specifying-inputs"><a class="header" href="#specifying-inputs">Specifying inputs</a></h2>
<p>We can override the values of any scalar variables by specifying them as input
variables.  To do this, we add a line at the top of the code to specify that
these are input variables:</p>
<pre><code>in = [k]
k { 1.0 }
</code></pre>
<h2 id="defining-state-variables"><a class="header" href="#defining-state-variables">Defining state variables</a></h2>
<p>The primary goal of the DSL is to define a set of differential equations of a
system of state variables.  To define the state variables, we create a special
vector variable <code>u_i</code> which corresponds to the state variables $\mathbf{u}$.</p>
<p>The values that we use for <code>u_i</code> are the initial values of the state variables
at $t=0$.</p>
<pre><code>u_i {
  x = 1,
  y = 0,
  z = 0,
}
</code></pre>
<p>We can optionally define the time derivatives of the state variables,
$\mathbf{\dot{u}}$ as well:</p>
<pre><code>dudt_i {
  dxdt = 1,
  dydt = 0,
  dzdt = 0,
}
</code></pre>
<p>Here the initial values of the time derivatives are given, these are typically
used as a starting point to calculate a set of consistent initial values for the
state variables.</p>
<p>Note that there is no need to define <code>dudt</code> if you do not define a mass matrix $M$.</p>
<h2 id="defining-the-ode-system-equations"><a class="header" href="#defining-the-ode-system-equations">Defining the ODE system equations</a></h2>
<p>Recall that the DAE system is defined by the equations:</p>
<p>$$
M(t) \frac{d\mathbf{u}}{dt} = F(\mathbf{u}, t)
$$</p>
<p>We now define the equations $F$ and $M$ that we want to solve, using the
variables that we have defined earlier. We do this by defining a vector variable
<code>F_i</code> that corresponds to the RHS of the equations.</p>
<p>For example, to define a simple system of ODEs:</p>
<p>$$
\begin{align*}
\frac{dx}{dt} &amp;= y \
\frac{dy}{dt} &amp;= -x \
x(0) &amp;= 1 \
y(0) &amp;= 0 \
\end{align*}
$$</p>
<p>We write:</p>
<pre><code>u_i {
 x = 1,
 y = 0,
}
F_i {
  y,
 -x,
}
</code></pre>
<p>We can also define a mass matrix $M$ by defining a vector variable <code>M_i</code>. This
is optional, and if not defined, the mass matrix is assumed to be the identity
matrix.</p>
<p>For example, lets define a simple DAE system using a singular mass matrix with a
zero on the diagonal:</p>
<p>$$
\begin{align*}
\frac{dx}{dt} &amp;= x \
0 &amp;= y-x \
x(0) &amp;= 1 \
y(0) &amp;= 0 \
\end{align*}
$$</p>
<p>We write:</p>
<pre><code>u_i {
 x = 1,
 y = 0,
}
dudt_i {
 dxdt = 0,
 dydt = 1,
}
M_i {
 dxdt,
 0,
}
F_i {
 x,
 y-x,
}
</code></pre>
<h2 id="specifying-outputs"><a class="header" href="#specifying-outputs">Specifying outputs</a></h2>
<p>Finally, we specify the outputs of the system. These might be the state
variables themselves, or they might be other variables that are calculated from
the state variables. Here we specify that we want to output the state variables
$x$ and $y$:</p>
<pre><code>out_i {
  x,
  y,
}
</code></pre>
<h2 id="required-variables"><a class="header" href="#required-variables">Required variables</a></h2>
<p>The DSL allows the user to specify an arbitrary number of intermediate
variables, but certain variables are required to be defined. These are:</p>
<ul>
<li><code>u_i</code> - the state variables</li>
<li><code>F_i</code> - the vector $F(\mathbf{u}, t)$</li>
<li><code>out_i</code> - the output variables</li>
</ul>
<h2 id="predefined-variables"><a class="header" href="#predefined-variables">Predefined variables</a></h2>
<p>The only predefined variable is the scalar $t$ which is the current time, this
allows the equations to be written as functions of time. For example</p>
<pre><code>F_i {
  k1 * t + sin(t)
}
</code></pre>
<h2 id="mathematical-functions"><a class="header" href="#mathematical-functions">Mathematical functions</a></h2>
<p>The DSL supports the following mathematical functions:</p>
<ul>
<li><code>pow(x, y)</code> - x raised to the power of y</li>
<li><code>sin(x)</code> - sine of x</li>
<li><code>cos(x)</code> - cosine of x</li>
<li><code>tan(x)</code> - tangent of x</li>
<li><code>exp(x)</code> - exponential of x</li>
<li><code>log(x)</code> - natural logarithm of x</li>
<li><code>sqrt(x)</code> - square root of x</li>
<li><code>abs(x)</code> - absolute value of x</li>
<li><code>sigmoid(x)</code> - sigmoid function of x</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
